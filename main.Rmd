---
title: "Mapping the Zone of Uncertainty"
output: html_document
---

## Dependencies

```{r}

library (MASS)
library (tidyverse)
library (magrittr)

library (foreign)
library (gamlss)
library (haven)

library (cowplot)

sessionInfo ()

set.seed (1919)

```

## Functions

```{r}

source ("functions.R")

```

## Data

```{r}

source ("data.R")

```

## Models

```{r}

source ("models.R")

```

## Results

```{r}

mu_healthy <- get_mu (model_healthy)
sigma_healthy <- get_sigma (model_healthy)
nu_healthy <- get_nu (model_healthy)

lln_healthy <- qBCCG (0.05, mu_healthy, sigma_healthy, nu_healthy)

mu_diseased <- get_mu (model_diseased_bcpe$model)
sigma_diseased <- get_sigma (model_diseased_bcpe$model)
nu_diseased <- get_nu (model_diseased_bcpe$model)
tau_diseased <- get_tau (model_diseased_bcpe$model)

uln_diseased <- qBCPE (0.95, mu_diseased, sigma_diseased, nu_diseased, tau_diseased)

prior_healthy <- model_diseased_bcpe$priors [1]
prior_diseased <- model_diseased_bcpe$priors [2]

```

Number of NHANES participants

```{r}

nrow (nhanes)

```

Number of healthy NHANES participants

```{r}

nrow (nhanes_healthy)

```

Number of UPHS patients

```{r}

nrow (uphs)

```

Median age of UPHS participants

```{r}

uphs %>%
  pull (age) %>%
  median ()

```

IQR of ages of UPHS participants

```{r}

uphs %>%
  pull (age) %>%
  IQR ()

```

Number of women among UPHS partients

```{r}

uphs %>%
  filter (sex == 2) %>%
  nrow ()

```

Percentage of women among UPHS patients

```{r}

uphs %>%
  filter (sex == 2) %>%
  nrow () %>%
  divide_by (nrow (uphs)) %>%
  multiply_by (100) %>%
  round (digits = 1)

```

Number of UPHS participants who were non-Hispanic and White

```{r}

uphs %>%
  filter (race == 1) %>%
  nrow ()

```

Percentage of UPHS participants who were non-Hispanic and White

```{r}

uphs %>%
  filter (race == 1) %>%
  nrow () %>%
  divide_by (nrow (uphs)) %>%
  multiply_by (100) %>%
  round (digits = 1)

```

Median FEV1/FVC among UPHS patients

```{r}

uphs %>%
  pull (fev1_fvc) %>%
  median () %>%
  round (digits = 2)

```

IQR of FEV1/FVC values among UPHS patients

```{r}

uphs %>%
  pull (fev1_fvc) %>%
  IQR () %>%
  round (digits = 2)

```

Mu healthy

```{r}

format (round (mu_healthy, digits = 2), nsmall = 2)

```

Sigma healthy

```{r}

format (round (sigma_healthy, digits = 2), nsmall = 2)

```

Nu healthy

```{r}

format (round (nu_healthy, digits = 2), nsmall = 2)

```

Healthy LLN

```{r}

format (round (lln_healthy, digits = 2), nsmall = 2)

```

Number of UPHS patients with an FEV1/FVC less than the LLN

```{r}

uphs %>%
  filter (fev1_fvc < lln_healthy) %>%
  nrow ()

```

Percentage of UPHS patients with an FEV1/FVC less than the LLN

```{r}

uphs %>%
  filter (fev1_fvc < lln_healthy) %>%
  nrow () %>%
  divide_by (nrow (uphs)) %>%
  multiply_by (100) %>%
  round (digits = 1)  

```

Mu diseased

```{r}

format (round (mu_diseased, digits = 2), nsmall = 2)

```

Sigma diseased

```{r}

format (round (sigma_diseased, digits = 2), nsmall = 2)

```

Nu diseased

```{r}

format (round (nu_diseased, digits = 2), nsmall = 2)

```

Tau diseased

```{r}

format (round (tau_diseased, digits = 2), nsmall = 2)

```

Prior healthy

```{r}

format (round (100 * prior_healthy, digits = 1), nsmall = 1)

```

Prior diseased

```{r}

format (round (100 * prior_diseased, digits = 1), nsmall = 1)

```

Zone of uncertainty

```{r}

zone_upper <- qBCPE (
  0.99,
  mu = mu_diseased,
  sigma = sigma_diseased,
  nu = nu_diseased,
  tau = tau_diseased
) 
  
zone_lower <- qBCCG (
  0.01,
  mu = mu_healthy,
  sigma = sigma_healthy,
  nu = nu_healthy
)

paste (
  "[",
  format (round (zone_lower, digits = 2), nsmall = 2),
  ", ",
  format (round (zone_upper, digits = 2), nsmall = 2),
  "]",
  sep = ""
)

```

Number of UPHS patients in the zone of uncertainty

```{r}

uphs %>% 
  filter (fev1_fvc >= zone_lower & fev1_fvc <= zone_upper) %>% 
  nrow ()

```

Percentage of UPHS patients in zone of uncertainty

```{r}

uphs %>% 
  filter (fev1_fvc >= zone_lower & fev1_fvc <= zone_upper) %>% 
  nrow () %>% 
  divide_by (nrow (uphs)) %>%
  multiply_by (100) %>%
  round (digits = 1)  

```

Number of UPHS patients with a normal FEV1/FVC in the zone of uncertainty

```{r}

uphs %>% 
  filter (fev1_fvc >= lln_healthy) %>% 
  filter (fev1_fvc >= zone_lower & fev1_fvc <= zone_upper) %>%
  nrow ()

```

Percentage of UPHS patients with a normal FEV1/FVC in the zone of uncertainty

```{r}

uphs %>% 
  filter (fev1_fvc >= lln_healthy) %>% 
  filter (fev1_fvc >= zone_lower & fev1_fvc <= zone_upper) %>%
  nrow () %>% 
  divide_by (nrow (filter (uphs, fev1_fvc >= lln_healthy))) %>%
  multiply_by (100) %>%
  round (digits = 1)   

```

Number of UPHS patients with an abnormal FEV1/FVC in the zone of uncertainty

```{r}

uphs %>% 
  filter (fev1_fvc < lln_healthy) %>% 
  filter (fev1_fvc >= zone_lower & fev1_fvc <= zone_upper) %>%
  nrow ()

```

Percentage of UPHS patients with an abnormal FEV1/FVC in the zone of uncertainty

```{r}

uphs %>% 
  filter (fev1_fvc < lln_healthy) %>% 
  filter (fev1_fvc >= zone_lower & fev1_fvc <= zone_upper) %>%
  nrow () %>% 
  divide_by (nrow (filter (uphs, fev1_fvc < lln_healthy))) %>%
  multiply_by (100) %>%
  round (digits = 1)    

```

## Figure 1

```{r}

color_diseased <- "#B24745FF"
color_healthy <- "#79AF97FF"
color_uncertain <- "#FDD262"

# Figure 1a

n <- nrow (uphs)

fev1_fvc <- pull (uphs, fev1_fvc)

healthy <- dBCCG (
  fev1_fvc,
  mu = mu_healthy,
  sigma = sigma_healthy,
  nu = nu_healthy
)

diseased <- dBCCG (
  fev1_fvc,
  mu = 0.62,
  sigma = 0.1,
  nu = 5
)

data <- tibble (
  fev1_fvc = fev1_fvc,
  healthy = healthy * 0.02 * n * 0.6,
  diseased = diseased * 0.02 * n * 0.4
)

data <- data %>% 
  mutate (healthy_min = case_when (
    diseased >= healthy ~ 0,
    healthy > diseased ~ diseased)
  ) %>% 
  mutate (healthy_max = case_when (
    diseased >= healthy ~ 0,
    healthy > diseased ~ healthy)
  ) %>% 
  mutate (diseased_min = case_when (
    healthy >= diseased ~ 0,
    diseased > healthy ~ healthy)
  ) %>% 
  mutate (diseased_max = case_when (
    healthy >= diseased ~ 0,
    diseased > healthy ~ diseased)
  ) %>% 
  mutate (uncertain_min = 0) %>% 
  mutate (uncertain_max = case_when (
    healthy >= diseased ~ diseased,
    diseased > healthy ~ healthy)
  )

figure_1a <- data %>%
  ggplot +
  geom_line (aes (fev1_fvc, healthy)) +
  geom_ribbon (aes (fev1_fvc, ymax = healthy_max, ymin = healthy_min, fill = "Healthy"), alpha = 0.5) +
  geom_line (aes (fev1_fvc, diseased)) +
  geom_ribbon (aes (fev1_fvc, ymax = diseased_max, ymin = diseased_min, fill = "Diseased"), alpha = 0.5) +
  geom_ribbon (aes (fev1_fvc, ymax = uncertain_max, ymin = uncertain_min, fill = "Uncertain"), alpha = 0.5) +
  theme_classic (base_size = 10) +
  scale_fill_manual (
    name = "",
    breaks = c (
      "Healthy",
      "Uncertain",
      "Diseased"
    ),
    values = c (
      color_healthy,
      color_uncertain,
      color_diseased
    ),
    labels = c (
      "Healthy",
      "Uncertain",
      "Diseased"
    )
  ) +
  scale_x_continuous (
    expression ("FEV"["1"] * "/FVC"),
    limits = c (min (fev1_fvc), 1.0),
    breaks = NULL,
    labels = NULL
  ) +
  scale_y_continuous (
    "",
    limits = c (0, 4000),
    breaks = NULL,
    labels = NULL,
    #breaks = c (0, 1000, 2000, 3000, 4000),
    #labels = c ("", "", "", "", "")
    #labels = c ("0", "1000", "2000", "3000", "4000")
  ) +
  guides (fill = guide_legend (override.aes = list (alpha = 0.5))) +
  geom_segment (x = min (fev1_fvc), y = 0, xend = 1.0, yend = 0)


ggsave ("../figures/figure-1a.png", width = 15, height = 10, units = "cm")

# Figure 1b

n <- nrow (uphs)

fev1_fvc <- pull (uphs, fev1_fvc)

healthy <- dBCCG (
  fev1_fvc,
  mu = mu_healthy,
  sigma = sigma_healthy,
  nu = nu_healthy
)

diseased <- dBCPE (
  fev1_fvc,
  mu = mu_diseased,
  sigma = sigma_diseased,
  nu = nu_diseased,
  tau = tau_diseased
)

data <- tibble (
  fev1_fvc = fev1_fvc,
  healthy = healthy * 0.02 * n * prior_healthy,
  diseased = diseased * 0.02 * n * prior_diseased
)

data <- data %>% 
  mutate (healthy_min = case_when (
    diseased >= healthy ~ 0,
    healthy > diseased ~ diseased)
  ) %>% 
  mutate (healthy_max = case_when (
    diseased >= healthy ~ 0,
    healthy > diseased ~ healthy)
  ) %>% 
  mutate (diseased_min = case_when (
    healthy >= diseased ~ 0,
    diseased > healthy ~ healthy)
  ) %>% 
  mutate (diseased_max = case_when (
    healthy >= diseased ~ 0,
    diseased > healthy ~ diseased)
  ) %>% 
  mutate (uncertain_min = 0) %>% 
  mutate (uncertain_max = case_when (
    healthy >= diseased ~ diseased,
    diseased > healthy ~ healthy)
  )

figure_1b <- data %>%
  ggplot +
  geom_histogram (aes (x = fev1_fvc), color = "black", fill = "white", binwidth = 0.02) +
  geom_line (aes (fev1_fvc, healthy)) +
  geom_ribbon (aes (fev1_fvc, ymax = healthy_max, ymin = healthy_min, fill = "Healthy"), alpha = 0.5) +
  geom_line (aes (fev1_fvc, diseased)) +
  geom_ribbon (aes (fev1_fvc, ymax = diseased_max, ymin = diseased_min, fill = "Diseased"), alpha = 0.5) +
  geom_ribbon (aes (fev1_fvc, ymax = uncertain_max, ymin = uncertain_min, fill = "Uncertain"), alpha = 0.5) +
  xlab (expression ("FEV"["1"] * "/FVC")) +
  theme_classic (base_size = 10) +
  scale_fill_manual (
    name = "",
    breaks = c (
      "Healthy",
      "Uncertain",
      "Diseased"
    ),
    values = c (
      color_healthy,
      color_uncertain,
      color_diseased
    ),
    labels = c (
      "Healthy",
      "Uncertain",
      "Diseased"
    )
  ) +
  scale_y_continuous (
    "Number of Patients",
    limits = c (0, 4000),
    breaks = c (0, 1000, 2000, 3000, 4000),
    labels = c ("0", "1000", "2000", "3000", "4000")
  ) +
  guides (fill = guide_legend (override.aes = list (alpha = 0.5)))  


ggsave ("../figures/figure-1b.png", width = 15, height = 10, units = "cm")

figure_1 <- plot_grid (
  figure_1a + theme (legend.position = "none"),
  figure_1b + theme (legend.position = "none"),
  align = "vh",
  labels = c ("A", "B"),
  label_size = 10,
  nrow = 2
)

legend = get_legend (figure_1a)

plot_grid (figure_1, legend, ncol = 2, rel_widths = c (0.8, 0.2), label_size = 50)

ggsave ("../figures/figure-1.png", width = 15, height = 20, units = "cm")

```
